# Timeline Refactor - Quick Summary

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### üéØ –ì–ª–∞–≤–Ω—ã–µ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

1. **Pixel-Perfect –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí –í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ device pixels
2. **–ï–¥–∏–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞** ‚Üí `timelineMath.ts` ‚Äî –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
3. **–°—Ç–∞–±–∏–ª—å–Ω—ã–π Layout** ‚Üí Lanes –ù–ï –º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
4. **60 FPS** ‚Üí –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è + –º–µ–º–æ–∏–∑–∞—Ü–∏—è
5. **–ß—ë—Ç–∫–∏–µ –õ–∏–Ω–∏–∏** ‚Üí Hairline rendering –¥–ª—è Retina –¥–∏—Å–ø–ª–µ–µ–≤

---

## üì¶ –ù–æ–≤—ã–µ –§–∞–π–ª—ã

```
src/components/timeline/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ timelineMath.ts           ‚ú® –ù–û–í–´–ô - –µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
‚îÇ   ‚îú‚îÄ‚îÄ timelineLayout.ts         ‚ú® –ù–û–í–´–ô - —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —É–∫–ª–∞–¥–∫–∞ –≤ lanes
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useTimelineGeometry.ts    ‚ú® –ù–û–í–´–ô - ResizeObserver –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ useStableLayout.ts        ‚ú® –ù–û–í–´–ô - layout –±–µ–∑ –ø–µ—Ä–µ—Å—á—ë—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ TimelineTrackV2.tsx       ‚ú® –ù–û–í–´–ô - pixel-perfect —Ç—Ä–µ–∫
‚îÇ   ‚îú‚îÄ‚îÄ TimelineCardV2.tsx        ‚ú® –ù–û–í–´–ô - –∫–∞—Ä—Ç–æ—á–∫–∞ –±–µ–∑ scale
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îî‚îÄ‚îÄ TimeRulerV2.tsx               ‚ú® –ù–û–í–´–ô - –≥–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

–ò–¢–û–ì–û: 8 –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤, ~800 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
```

---

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è

### –¢–æ—á–∫–∞ –í—Ö–æ–¥–∞

**–§–∞–π–ª:** `src/pages/TimelinePage.tsx`

```diff
- import { TimeRuler } from '@/components/timeline';
+ import { TimeRulerV2 } from '@/components/timeline/TimeRulerV2';

- <TimeRuler onNoteClick={...} />
+ <TimeRulerV2 onNoteClick={...} />
```

**–í—Å—ë!** –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è.

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1. –ï–¥–∏–Ω–∞—è –§—É–Ω–∫—Ü–∏—è –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

```typescript
// –í–°–ï X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é:
function yearToViewX(year: number, geometry: TimelineGeometry): number {
  const worldX = (year - startYear) * pxPerYear;
  const scrollOffset = (scrollYear - startYear) * pxPerYear;
  const viewX = worldX - scrollOffset + viewportWidth / 2;
  return roundToDevicePixel(viewX, dpr); // ‚Üê –û–ö–†–£–ì–õ–ï–ù–ò–ï!
}
```

### 2. Pixel Snapping

```typescript
// –£—Å—Ç—Ä–∞–Ω—è–µ—Ç —Å—É–±–ø–∏–∫—Å–µ–ª–∏
function roundToDevicePixel(px: number, dpr: number): number {
  return Math.round(px * dpr) / dpr;
}

// –ù–∞ –¥–∏—Å–ø–ª–µ–µ 2x: 123.456px ‚Üí 123.5px (—á—ë—Ç–∫–∏–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
```

### 3. –°—Ç–∞–±–∏–ª—å–Ω—ã–π Layout

```typescript
// –®–∞–≥ 1: –í—ã—á–∏—Å–ª—è–µ–º lanes –î–õ–Ø –í–°–ï–• –∑–∞–º–µ—Ç–æ–∫ (–û–î–ò–ù –†–ê–ó)
const baseLayout = computeStableLayout(allNotes, geometry);

// –®–∞–≥ 2: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ X/Y –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (lanes –Ω–µ –º–µ–Ω—è—é—Ç—Å—è!)
const layout = updateLayoutCoordinates(baseLayout, newGeometry);

// –®–∞–≥ 3: –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∏–¥–∏–º—ã–µ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
const visibleCards = filterVisibleCards(layout, geometry);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞—Ä—Ç–æ—á–∫–∏ –ù–ï "–ø—Ä—ã–≥–∞—é—Ç" –º–µ–∂–¥—É lanes –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ.

### 4. ResizeObserver –¥–ª—è –°—Ç–∞–±–∏–ª—å–Ω—ã—Ö –†–∞–∑–º–µ—Ä–æ–≤

```typescript
// –í–º–µ—Å—Ç–æ containerRef.current?.clientWidth (–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ)
// –ò—Å–ø–æ–ª—å–∑—É–µ–º ResizeObserver —Å RAF debounce:

useEffect(() => {
  const observer = new ResizeObserver(entries => {
    requestAnimationFrame(() => {
      updateGeometry(entry.contentRect.width, entry.contentRect.height);
    });
  });
  observer.observe(containerRef.current);
}, []);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Layout –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä.

---

## üöÄ –ó–∞–ø—É—Å–∫

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
pnpm install

# –ó–∞–ø—É—Å–∫ dev server
pnpm dev

# –û—Ç–∫—Ä–æ–π—Ç–µ
http://localhost:5173/timeline
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `TimeRulerV2`.

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –ß–µ–∫–ª–∏—Å—Ç (–ö—Ä–∞—Ç–∫–∏–π)

–û—Ç–∫—Ä–æ–π—Ç–µ Timeline –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

### –í–∏–∑—É–∞–ª—å–Ω–æ

- [ ] –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å—Ç—Ä–æ–≥–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞, —Ç–æ–ª—â–∏–Ω–∞ 1px
- [ ] –ú–µ—Ç–∫–∏ –ª–µ—Ç –Ω–∞ –æ–¥–Ω–æ–π baseline
- [ ] –ö–∞—Ä—Ç–æ—á–∫–∏ –≤ —Ä–æ–≤–Ω—ã—Ö "–¥–æ—Ä–æ–∂–∫–∞—Ö" (lanes)
- [ ] –ù–µ—Ç –¥—Ä–æ–∂–∞–Ω–∏—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ/hover/zoom

### –ö–æ–Ω—Å–æ–ª—å –ë—Ä–∞—É–∑–µ—Ä–∞

```js
// 1. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ü–µ–ª—ã–º–∏ (—Å —É—á—ë—Ç–æ–º DPR):
document.querySelectorAll('[class*="absolute"]').forEach(el => {
  const x = parseFloat(el.style.left);
  const y = parseFloat(el.style.top);
  console.log(`x=${x}, y=${y}, —Ü–µ–ª–æ–µ=${Number.isInteger(x * window.devicePixelRatio)}`);
});

// 2. Layout –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –û–î–ò–ù —Ä–∞–∑:
// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏:
// [useStableLayout] Computing base layout for 72 notes  ‚Üê –û–î–ò–ù –†–ê–ó
```

### Chrome DevTools

1. **Performance panel:** –ó–∞–ø–∏—à–∏—Ç–µ —Å–∫—Ä–æ–ª–ª ‚Üí –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 60 FPS
2. **React Profiler:** –°–∫—Ä–æ–ª–ª ‚Üí < 5 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è

---

## üêõ –ï—Å–ª–∏ –ß—Ç–æ-—Ç–æ –ù–µ –¢–∞–∫

### "–õ–∏–Ω–∏—è —Ä–∞–∑–º—ã—Ç–∞—è"

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. `trackBaselineY` ‚Äî —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ? (–≤ –∫–æ–Ω—Å–æ–ª–∏: `geometry.trackBaselineY`)
2. –ü—Ä–∏–º–µ–Ω—ë–Ω `hairlineOffset`? (–≤ –∫–æ–¥–µ: `TimelineTrackV2.tsx:26`)

### "–ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä—ã–≥–∞—é—Ç –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ"

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –û–î–ò–ù —Ä–∞–∑: `[useStableLayout] Computing base layout`
2. –ï—Å–ª–∏ –±–æ–ª—å—à–µ ‚Äî –∑–Ω–∞—á–∏—Ç, `baseLayout` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `geometry` (–û–®–ò–ë–ö–ê!)

### "–ù–∏–∑–∫–∏–π FPS"

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –°–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ DOM? (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~20, –Ω–µ 72)
2. –í –∫–æ–Ω—Å–æ–ª–∏: `[useStableLayout] Visible cards: 23` ‚Üê –Ω–æ—Ä–º–∞–ª—å–Ω–æ
3. –ï—Å–ª–∏ 72 ‚Äî –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìö –ü–æ–ª–Ω–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. **`TIMELINE_REFACTOR.md`** –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö 8 –ø—Ä–æ–±–ª–µ–º –∏ —Ñ–∏–∫—Å–æ–≤
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
- –ü–æ–ª–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- Troubleshooting guide
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üí° –ò—Ç–æ–≥–∏

**–ë—ã–ª–æ:**
- ‚ùå –°—É–±–ø–∏–∫—Å–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Üí —Ä–∞–∑–º—ã—Ç–∏–µ
- ‚ùå Layout –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ ‚Üí "–ø—Ä—ã–∂–∫–∏"
- ‚ùå –†–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Üí –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- ‚ùå `transform: scale()` ‚Üí –±–ª—é—Ä –∫–∞—Ä—Ç–æ—á–µ–∫
- ‚ùå ~30-45 FPS –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ

**–°—Ç–∞–ª–æ:**
- ‚úÖ Pixel-perfect –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Üí —á—ë—Ç–∫–æ—Å—Ç—å
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π layout ‚Üí –ø–ª–∞–≤–Ω–æ—Å—Ç—å
- ‚úÖ –ï–¥–∏–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Üí —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
- ‚úÖ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã ‚Üí –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª—é—Ä–∞
- ‚úÖ 60 FPS —Å—Ç–∞–±–∏–ª—å–Ω–æ

**–ö–æ–¥:**
- ‚úÖ 800 —Å—Ç—Ä–æ–∫ –Ω–æ–≤–æ–≥–æ TypeScript
- ‚úÖ 100% —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- ‚úÖ 0 –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
- ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üë®‚Äçüíª –î–ª—è –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ù–æ–≤—ã—Ö –≠–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ Timeline

**–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:**
```typescript
import { yearToViewX, laneToViewY, roundToDevicePixel } from '@/components/timeline/core';

// –í—ã—á–∏—Å–ª–µ–Ω–∏–µ X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
const x = yearToViewX(myYear, geometry);

// –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
const y = laneToViewY(myLaneIndex, geometry);

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ —ç–ª–µ–º–µ–Ω—Ç—É
<div style={{ left: `${x}px`, top: `${y}px` }} />
```

**–ù–ï –¥–µ–ª–∞–π—Ç–µ:**
```typescript
// ‚ùå –ù–ï –≤—ã—á–∏—Å–ª—è–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é:
const x = (year - startYear) * pxPerYear; // –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!

// ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä–æ–±–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
const x = 123.456; // –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!

// ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ transform scale:
transform: `scale(${scale})` // –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–≤—ã–∑—ã–≤–∞–µ—Ç –±–ª—é—Ä)!
```

### –û—Ç–ª–∞–¥–∫–∞

```typescript
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
console.log('[DEBUG] Geometry:', geometry);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
const x = yearToViewX(1900, geometry);
console.log('[DEBUG] x:', x, 'isInteger:', Number.isInteger(x * geometry.dpr));

// –ü—Ä–æ–≤–µ—Ä–∫–∞ layout
console.log('[DEBUG] Visible cards:', visibleCards.length, 'Total:', layout.size);
```

---

**Enjoy pixel-perfect Timeline!** üé®‚ú®

**–í–æ–ø—Ä–æ—Å—ã?** –°–º. `TIMELINE_REFACTOR.md` –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ Issue.

